const mainCategoriesContainer=document.getElementById("main-categories"),subCategoriesContainer=document.getElementById("sub-categories-container"),subCategories=document.getElementById("sub-categories"),promptCardsContainer=document.getElementById("prompt-cards-container"),searchInput=document.getElementById("search-input"),noResults=document.getElementById("no-results"),promptModal=document.getElementById("prompt-modal"),modalTitle=document.getElementById("modal-title"),modalChinese=document.getElementById("modal-chinese"),modalEnglish=document.getElementById("modal-english"),closeModal=document.getElementById("close-modal"),copyChinese=document.getElementById("copy-chinese"),copyEnglish=document.getElementById("copy-english"),themeToggle=document.getElementById("theme-toggle"),loadingIndicator=document.getElementById("loading-indicator");let currentMainCategory=null,currentSubCategory=null,searchQuery="",currentPage=1;const ITEMS_PER_PAGE=20,ITEMS_PER_LOAD=10;let loadedItemsCount=0,isLoading=!1,isDarkMode=!1,categorizedData={},allMainCategories=new Set,allSubCategories=new Set;const categoryFileMap={"生活服务":"/aiprompt_file/split_data/data-life-services.js","工作职业":"/aiprompt_file/split_data/data-work-career.js","内容创作":"/aiprompt_file/split_data/data-content-creation.js","学习提升":"/aiprompt_file/split_data/data-learning-improvement.js","休闲体验":"/aiprompt_file/split_data/data-leisure-experience.js","其他指令":"/aiprompt_file/split_data/data-other-instructions.js"},searchCache=new Map,loadingCategories=new Set;async function loadCategoryData(e){if(loadingCategories.has(e))return console.log("Category is already loading:",e),new Promise(t=>{const a=setInterval(()=>{loadingCategories.has(e)||(clearInterval(a),t())},100)});loadingCategories.add(e),loadingIndicator&&loadingIndicator.classList.remove("hidden");try{const t=categoryFileMap[e];if(console.log("Loading data file for category:",e,"Path:",t),!t)throw new Error(`No file path found for category: ${e}`);const a=`${t}?t=${Date.now()}`,o=document.createElement("script");o.async=!1,await new Promise((t,n)=>{o.onload=()=>{console.log("Data file loaded successfully for category:",e),void 0!==window.promptData?(processCategoryData(e,window.promptData),delete window.promptData,t()):n(new Error(`promptData is undefined after loading file for category: ${e}`))},o.onerror=t=>{console.error("Failed to load data file for category:",e,t),n(new Error(`Failed to load data file for category: ${e}`))},o.src=a,document.head.appendChild(o)})}catch(e){throw console.error("Error loading category data:",e),e}finally{loadingIndicator&&loadingIndicator.classList.add("hidden"),loadingCategories.delete(e)}}function processCategoryData(e,t){console.log("Processing data for category:",e,"Data length:",t?t.length:0),t&&Array.isArray(t)?(categorizedData[e]||(categorizedData[e]={}),t.forEach(e=>{const t=e.mainCategory,a=e.subCategory;if(!t||!a)return void console.warn("Item missing mainCategory or subCategory:",e);allMainCategories.add(t),allSubCategories.add(a),categorizedData[t]||(categorizedData[t]={}),categorizedData[t][a]||(categorizedData[t][a]=[]);categorizedData[t][a].some(t=>t.title===e.title&&t.chinese===e.chinese&&t.english===e.english)||categorizedData[t][a].push(e)}),console.log("Data processed for category:",e,"Categorized data keys:",Object.keys(categorizedData)),renderMainCategories()):console.error("Invalid data for category:",e,t)}function renderMainCategories(){const e=document.createDocumentFragment();Object.keys(categoryFileMap).forEach(t=>{const a=document.createElement("div");a.className="category-tag main-category "+(currentMainCategory===t?"active":"");let o=0;categorizedData[t]?Object.values(categorizedData[t]).forEach(e=>{o+=e.length}):window.categoryCounts&&(o=window.categoryCounts[t]||0),a.textContent=`${t} (${o})`,a.addEventListener("click",async()=>{if(currentMainCategory!==t){if(console.log("Category clicked:",t),currentMainCategory=t,currentSubCategory=null,currentPage=1,categorizedData[t])console.log("Data already loaded for category:",t);else{console.log("Loading data for category:",t);try{await loadCategoryData(t),console.log("Data loaded successfully for category:",t)}catch(e){console.error("Failed to load data for category:",t,e)}}renderMainCategories(),renderSubCategories(),renderPromptCards()}}),e.appendChild(a)}),mainCategoriesContainer.innerHTML="",mainCategoriesContainer.appendChild(e)}function renderSubCategories(){const e=document.createDocumentFragment();subCategoriesContainer.classList.toggle("hidden",null===currentMainCategory&&!searchQuery);let t=new Set,a={};currentMainCategory?categorizedData[currentMainCategory]?Object.keys(categorizedData[currentMainCategory]).forEach(e=>{t.add(e),a[e]=categorizedData[currentMainCategory][e].length}):console.log("Data for main category not loaded yet:",currentMainCategory):searchQuery?Object.values(categorizedData).forEach(e=>{Object.values(e).forEach(e=>{e.forEach(e=>{isMatch(e,searchQuery)&&(t.add(e.subCategory),a[e.subCategory]=(a[e.subCategory]||0)+1)})})}):(t=allSubCategories,Object.values(categorizedData).forEach(e=>{Object.values(e).forEach(e=>{e.forEach(e=>{a[e.subCategory]=(a[e.subCategory]||0)+1})})}));const o=document.createElement("div");o.className="category-tag sub-category "+(null===currentSubCategory?"active":"");let n=0;Object.values(a).forEach(e=>{n+=e}),o.textContent=`全部 (${n})`,o.addEventListener("click",()=>{currentSubCategory=null,currentPage=1,loadedItemsCount=0,renderSubCategories(),renderPromptCards(!0)}),e.appendChild(o),Array.from(t).forEach(t=>{const o=document.createElement("div");o.className="category-tag sub-category "+(currentSubCategory===t?"active":""),o.textContent=`${t} (${a[t]||0})`,o.addEventListener("click",()=>{currentSubCategory=t,currentPage=1,loadedItemsCount=0,renderSubCategories(),renderPromptCards(!0)}),e.appendChild(o)}),subCategories.innerHTML="",subCategories.appendChild(e)}function renderPromptCards(e=!1){let t=[];if(currentMainCategory&&currentSubCategory?t=categorizedData[currentMainCategory]?.[currentSubCategory]||[]:currentMainCategory?categorizedData[currentMainCategory]&&Object.values(categorizedData[currentMainCategory]||{}).forEach(e=>{t=t.concat(e)}):currentSubCategory?Object.values(categorizedData).forEach(e=>{e[currentSubCategory]&&(t=t.concat(e[currentSubCategory]))}):Object.values(categorizedData).forEach(e=>{Object.values(e).forEach(e=>{t=t.concat(e)})}),searchQuery){const e=searchQuery.toLowerCase();searchCache.has(e)?t=searchCache.get(e):(t=t.filter(e=>isMatch(e,searchQuery)),searchCache.set(e,t))}if(0===t.length)noResults.classList.remove("hidden"),promptCardsContainer.innerHTML="",removeLoadMoreButton();else{noResults.classList.add("hidden");if(window.innerWidth<=768){e&&(loadedItemsCount=0,promptCardsContainer.innerHTML="");const a=loadedItemsCount,o=Math.min(a+10,t.length);t.slice(a,o).forEach(e=>{const t=document.createElement("div");t.className="prompt-card fade-in",t.innerHTML=`\n                    <h3 class="mb-1">${e.title}</h3>\n                    <div class="text-xs text-gray-500 mt-auto">\n                        <span>${e.subCategory}</span>\n                    </div>\n                `,t.addEventListener("click",()=>openPromptModal(e)),promptCardsContainer.appendChild(t)}),loadedItemsCount=o,removeLoadMoreButton(),loadedItemsCount<t.length&&addLoadMoreButton()}else{promptCardsContainer.innerHTML="";const e=20*(currentPage-1),a=Math.min(e+20,t.length);t.slice(e,a).forEach(e=>{const t=document.createElement("div");t.className="prompt-card fade-in",t.innerHTML=`\n                    <h3 class="mb-1">${e.title}</h3>\n                    <div class="text-xs text-gray-500 mt-auto">\n                        <span>${e.subCategory}</span>\n                    </div>\n                `,t.addEventListener("click",()=>openPromptModal(e)),promptCardsContainer.appendChild(t)}),renderPagination(t.length)}}}function addLoadMoreButton(){const e=document.createElement("div");e.className="col-span-full text-center mt-6",e.id="load-more-container";const t=document.createElement("button");t.className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition-colors",t.textContent="加载更多";const a=document.createElement("div");a.className="hidden mt-2 text-gray-500",a.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i>加载中...',a.id="load-more-indicator",t.addEventListener("click",()=>{isLoading||loadMoreItems()}),e.appendChild(t),e.appendChild(a),promptCardsContainer.appendChild(e)}function removeLoadMoreButton(){const e=document.getElementById("load-more-container");e&&e.remove()}function loadMoreItems(){isLoading=!0;const e=document.getElementById("load-more-container");if(e){const t=e.querySelector("button"),a=document.getElementById("load-more-indicator");t&&a&&(t.classList.add("hidden"),a.classList.remove("hidden"))}setTimeout(()=>{renderPromptCards(!1),isLoading=!1;const e=document.getElementById("load-more-container");if(e){const t=e.querySelector("button"),a=document.getElementById("load-more-indicator");t&&a&&(t.classList.remove("hidden"),a.classList.add("hidden"))}},300)}function renderPagination(e){const t=Math.ceil(e/20);if(t<=1)return;const a=document.createElement("div");a.className="col-span-full",a.id="pagination-controls";const o=document.createElement("button");o.className="prev-btn "+(1===currentPage?"disabled":""),o.textContent="上一页",o.disabled=1===currentPage,o.addEventListener("click",()=>{currentPage>1&&(currentPage--,renderPromptCards(),window.scrollTo({top:0,behavior:"smooth"}))}),a.appendChild(o);let n=Math.max(1,currentPage-3),r=Math.min(t,n+6);r-n<6&&(n=Math.max(1,r-6));for(let e=n;e<=r;e++){const t=document.createElement("button");t.className="page-btn "+(e===currentPage?"active":""),t.textContent=e,t.addEventListener("click",()=>{currentPage=e,renderPromptCards(),window.scrollTo({top:0,behavior:"smooth"})}),a.appendChild(t)}const d=document.createElement("button");d.className="next-btn "+(currentPage===t?"disabled":""),d.textContent="下一页",d.disabled=currentPage===t,d.addEventListener("click",()=>{currentPage<t&&(currentPage++,renderPromptCards(),window.scrollTo({top:0,behavior:"smooth"}))}),a.appendChild(d),promptCardsContainer.appendChild(a)}function isMatch(e,t){const a=t.toLowerCase();return e.title.toLowerCase().includes(a)||e.chinese.toLowerCase().includes(a)||e.english.toLowerCase().includes(a)}function openPromptModal(e){modalTitle.textContent=e.title,modalChinese.textContent=e.chinese,modalEnglish.textContent=e.english,initExpandCollapse("chinese",e.chinese),initExpandCollapse("english",e.english),promptModal.classList.remove("hidden"),document.body.style.overflow="hidden"}function initExpandCollapse(e,t){const a="chinese"===e?modalChinese:modalEnglish,o="chinese"===e?document.getElementById("toggle-chinese"):document.getElementById("toggle-english"),n="chinese"===e?document.getElementById("chinese-overlay"):document.getElementById("english-overlay");o.classList.add("hidden"),n.classList.add("hidden");const r=parseInt(window.getComputedStyle(a).lineHeight);a.clientHeight;setTimeout(()=>{a.scrollHeight>6*r&&(o.classList.remove("hidden"),n.classList.remove("hidden"),a.style.maxHeight=6*r+"px",a.style.overflow="hidden",o.querySelector(".expand-text").classList.remove("hidden"),o.querySelector(".collapse-text").classList.add("hidden"),o.onclick=function(){a.style.maxHeight?(a.style.maxHeight=null,a.style.overflow=null,n.classList.add("hidden"),o.querySelector(".expand-text").classList.add("hidden"),o.querySelector(".collapse-text").classList.remove("hidden")):(a.style.maxHeight=6*r+"px",a.style.overflow="hidden",n.classList.remove("hidden"),o.querySelector(".expand-text").classList.remove("hidden"),o.querySelector(".collapse-text").classList.add("hidden"))})},0)}function closePromptModal(){promptModal.classList.add("hidden"),document.body.style.overflow=""}function copyToClipboard(e,t){navigator.clipboard.writeText(e).then(()=>{const e=document.createElement("div");e.className="copy-toast",e.textContent=`${t}已复制!`,document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),10),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>document.body.removeChild(e),300)},3e3)})}function toggleDarkMode(){isDarkMode=!isDarkMode,document.body.classList.toggle("dark-mode",isDarkMode);const e=themeToggle.querySelector("i");isDarkMode?(e.className="fa fa-sun-o",localStorage.setItem("theme","dark")):(e.className="fa fa-moon-o",localStorage.setItem("theme","light"))}function applySavedTheme(){if("dark"===localStorage.getItem("theme")){isDarkMode=!0,document.body.classList.add("dark-mode");themeToggle.querySelector("i").className="fa fa-sun-o"}}function handleSearch(){searchQuery=searchInput.value.trim(),currentPage=1,loadedItemsCount=0,renderSubCategories(),renderPromptCards(!0)}function handleResize(){currentPage=1,loadedItemsCount=0,renderPromptCards(!0)}closeModal.addEventListener("click",closePromptModal),promptModal.addEventListener("click",e=>{e.target===promptModal&&closePromptModal()}),copyChinese.addEventListener("click",()=>{copyToClipboard(modalChinese.textContent,"中文提示词")}),copyEnglish.addEventListener("click",()=>{copyToClipboard(modalEnglish.textContent,"英文提示词")}),searchInput.addEventListener("input",handleSearch),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),handleSearch())}),themeToggle.addEventListener("click",toggleDarkMode),window.addEventListener("resize",handleResize),document.addEventListener("DOMContentLoaded",()=>{allMainCategories=new Set(Object.keys(categoryFileMap)),console.log("All main categories initialized:",Array.from(allMainCategories)),console.log("Rendering categories with preloaded counts"),renderMainCategories(),allMainCategories.size>0?(currentMainCategory=Array.from(allMainCategories)[0],console.log("Default category selected:",currentMainCategory),loadCategoryData(currentMainCategory).then(()=>{console.log("Default category data loaded successfully"),renderMainCategories(),renderSubCategories(),renderPromptCards(!0)}).catch(e=>{console.error("Failed to load default category data:",e),renderMainCategories(),renderSubCategories(),renderPromptCards(!0)})):(console.log("No categories found"),renderMainCategories(),renderSubCategories(),renderPromptCards(!0)),applySavedTheme()});