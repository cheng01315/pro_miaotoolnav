// DOM元素
const mainCategoriesContainer = document.getElementById('main-categories');
const subCategoriesContainer = document.getElementById('sub-categories-container');
const subCategories = document.getElementById('sub-categories');
const promptCardsContainer = document.getElementById('prompt-cards-container');
const searchInput = document.getElementById('search-input');
const noResults = document.getElementById('no-results');
const promptModal = document.getElementById('prompt-modal');
const modalTitle = document.getElementById('modal-title');
const modalChinese = document.getElementById('modal-chinese');
const modalEnglish = document.getElementById('modal-english');
const closeModal = document.getElementById('close-modal');
const copyChinese = document.getElementById('copy-chinese');
const copyEnglish = document.getElementById('copy-english');
const themeToggle = document.getElementById('theme-toggle'); // 夜间模式切换按钮
const loadingIndicator = document.getElementById('loading-indicator'); // 加载指示器

// 状态管理
let currentMainCategory = null;
let currentSubCategory = null;
let searchQuery = '';
let currentPage = 1;
const ITEMS_PER_PAGE = 20; // 每页显示20个项目
const ITEMS_PER_LOAD = 10; // 移动端每次加载10个项目
let loadedItemsCount = 0; // 已加载的项目数量
let isLoading = false; // 是否正在加载
let isDarkMode = false; // 夜间模式状态

// 按需加载的数据
let categorizedData = {};
let allMainCategories = new Set();
let allSubCategories = new Set();

// 大分类到数据文件的映射
const categoryFileMap = {
    '生活服务': 'split_data/data-life-services.js',
    '工作职业': 'split_data/data-work-career.js',
    '内容创作': 'split_data/data-content-creation.js',
    '学习提升': 'split_data/data-learning-improvement.js',
    '休闲体验': 'split_data/data-leisure-experience.js',
    '其他指令': 'split_data/data-other-instructions.js'
};

// 搜索结果缓存
const searchCache = new Map();

// 跟踪正在加载的分类
const loadingCategories = new Set();

// 动态加载数据文件
async function loadCategoryData(category) {
    // 检查该分类是否正在加载
    if (loadingCategories.has(category)) {
        console.log('Category is already loading:', category);
        // 等待加载完成
        return new Promise((resolve) => {
            const checkLoading = setInterval(() => {
                if (!loadingCategories.has(category)) {
                    clearInterval(checkLoading);
                    resolve();
                }
            }, 100);
        });
    }
    
    // 标记该分类正在加载
    loadingCategories.add(category);
    
    // 显示加载指示器
    if (loadingIndicator) {
        loadingIndicator.classList.remove('hidden');
    }
    
    try {
        // 获取数据文件路径
        const filePath = categoryFileMap[category];
        console.log('Loading data file for category:', category, 'Path:', filePath);
        
        // 检查文件路径是否存在
        if (!filePath) {
            throw new Error(`No file path found for category: aiprompt_file/${category}`);
        }
        
        // 添加时间戳参数避免缓存
        const filePathWithTimestamp = `${filePath}?t=${Date.now()}`;
        
        // 创建script标签动态加载数据文件
        const script = document.createElement('script');
        script.async = false; // 同步加载以确保顺序
        
        // 创建一个Promise来处理异步加载
        await new Promise((resolve, reject) => {
            script.onload = () => {
                console.log('Data file loaded successfully for category:', category);
                // 数据文件加载完成后，promptData变量会自动可用
                // 检查promptData是否存在
                if (typeof window.promptData === 'undefined') {
                    reject(new Error(`promptData is undefined after loading file for category: ${category}`));
                    return;
                }
                
                // 处理该分类的数据
                processCategoryData(category, window.promptData);
                // 清理window.promptData变量
                delete window.promptData;
                resolve();
            };
            
            script.onerror = (error) => {
                console.error('Failed to load data file for category:', category, error);
                reject(new Error(`Failed to load data file for category: ${category}`));
            };
            
            script.src = filePathWithTimestamp;
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading category data:', error);
        throw error;
    } finally {
        // 隐藏加载指示器
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
        
        // 标记该分类加载完成
        loadingCategories.delete(category);
    }
}

// 处理分类数据
function processCategoryData(category, data) {
    console.log('Processing data for category:', category, 'Data length:', data ? data.length : 0);
    
    // 检查数据是否存在
    if (!data || !Array.isArray(data)) {
        console.error('Invalid data for category:', category, data);
        return;
    }
    
    // 初始化该分类的数据结构
    if (!categorizedData[category]) {
        categorizedData[category] = {};
    }
    
    // 处理数据，按分类组织
    data.forEach(item => {
        const mainCat = item.mainCategory;
        const subCat = item.subCategory;
        
        // 检查必要的属性是否存在
        if (!mainCat || !subCat) {
            console.warn('Item missing mainCategory or subCategory:', item);
            return;
        }
        
        allMainCategories.add(mainCat);
        allSubCategories.add(subCat);
        
        if (!categorizedData[mainCat]) {
            categorizedData[mainCat] = {};
        }
        
        if (!categorizedData[mainCat][subCat]) {
            categorizedData[mainCat][subCat] = [];
        }
        
        // 检查是否已存在相同的项，避免重复添加
        const exists = categorizedData[mainCat][subCat].some(existingItem => 
            existingItem.title === item.title && 
            existingItem.chinese === item.chinese && 
            existingItem.english === item.english
        );
        
        if (!exists) {
            categorizedData[mainCat][subCat].push(item);
        }
    });
    
    console.log('Data processed for category:', category, 'Categorized data keys:', Object.keys(categorizedData));
    
    // 重新渲染分类以更新数量显示
    renderMainCategories();
}

// 渲染大分类（使用文档片段优化DOM操作）
function renderMainCategories() {
    // 创建文档片段以减少重排
    const fragment = document.createDocumentFragment();
    
    // 使用categoryFileMap的键来确保渲染所有分类
    Object.keys(categoryFileMap).forEach(category => {
        const categoryBtn = document.createElement('div');
        categoryBtn.className = `category-tag main-category ${currentMainCategory === category ? 'active' : ''}`;
        // 获取该大分类下的指令数量
        let count = 0;
        if (categorizedData[category]) {
            // 如果数据已加载，计算实际数量
            Object.values(categorizedData[category]).forEach(items => {
                count += items.length;
            });
        } else if (window.categoryCounts) {
            // 如果数据未加载，使用预加载的数量
            count = window.categoryCounts[category] || 0;
        }
        categoryBtn.textContent = `${category} (${count})`;
        categoryBtn.addEventListener('click', async () => {
            // 如果点击的是当前已选中的分类，则不重新加载
            if (currentMainCategory === category) {
                return;
            }
            
            console.log('Category clicked:', category);
            
            currentMainCategory = category;
            currentSubCategory = null;
            currentPage = 1;
            
            // 如果该分类数据还未加载，则动态加载
            if (!categorizedData[category]) {
                console.log('Loading data for category:', category);
                try {
                    await loadCategoryData(category);
                    console.log('Data loaded successfully for category:', category);
                } catch (error) {
                    console.error('Failed to load data for category:', category, error);
                    // 即使加载失败，也要重新渲染页面以保持UI一致性
                }
            } else {
                console.log('Data already loaded for category:', category);
            }
            
            renderMainCategories();
            renderSubCategories();
            renderPromptCards();
        });
        fragment.appendChild(categoryBtn);
    });
    
    // 一次性更新DOM
    mainCategoriesContainer.innerHTML = '';
    mainCategoriesContainer.appendChild(fragment);
}

// 渲染小分类（使用文档片段优化DOM操作）
function renderSubCategories() {
    // 创建文档片段以减少重排
    const fragment = document.createDocumentFragment();
    
    subCategoriesContainer.classList.toggle('hidden', currentMainCategory === null && !searchQuery);
    
    // 确定当前需要显示的小分类
    let relevantSubCategories = new Set();
    let subCategoryCounts = {}; // 存储每个小分类的指令数量
    
    if (currentMainCategory) {
        // 如果选择了大分类，只显示该大分类下的小分类
        if (categorizedData[currentMainCategory]) {
            Object.keys(categorizedData[currentMainCategory]).forEach(subCat => {
                relevantSubCategories.add(subCat);
                subCategoryCounts[subCat] = categorizedData[currentMainCategory][subCat].length;
            });
        } else {
            // 如果该大分类的数据还未加载，显示加载提示
            console.log('Data for main category not loaded yet:', currentMainCategory);
        }
    } else if (searchQuery) {
        // 如果有搜索词，显示所有包含匹配结果的小分类
        Object.values(categorizedData).forEach(mainCat => {
            Object.values(mainCat).forEach(items => {
                items.forEach(item => {
                    if (isMatch(item, searchQuery)) {
                        relevantSubCategories.add(item.subCategory);
                        subCategoryCounts[item.subCategory] = (subCategoryCounts[item.subCategory] || 0) + 1;
                    }
                });
            });
        });
    } else {
        // 否则显示所有小分类
        relevantSubCategories = allSubCategories;
        // 计算每个小分类的指令数量
        Object.values(categorizedData).forEach(mainCat => {
            Object.values(mainCat).forEach(items => {
                items.forEach(item => {
                    subCategoryCounts[item.subCategory] = (subCategoryCounts[item.subCategory] || 0) + 1;
                });
            });
        });
    }
    
    // 添加"全部"按钮
    const allCategoryBtn = document.createElement('div');
    allCategoryBtn.className = `category-tag sub-category ${currentSubCategory === null ? 'active' : ''}`;
    // 计算所有相关小分类的总指令数量
    let totalCount = 0;
    Object.values(subCategoryCounts).forEach(count => {
        totalCount += count;
    });
    allCategoryBtn.textContent = `全部 (${totalCount})`;
    allCategoryBtn.addEventListener('click', () => {
        currentSubCategory = null;
        currentPage = 1;
        loadedItemsCount = 0; // 修复：在移动端也需要重置已加载项目计数
        renderSubCategories();
        renderPromptCards(true); // 修复：在移动端需要重置卡片渲染
    });
    fragment.appendChild(allCategoryBtn);
    
    // 添加各个小分类
    Array.from(relevantSubCategories).forEach(category => {
        const categoryBtn = document.createElement('div');
        categoryBtn.className = `category-tag sub-category ${currentSubCategory === category ? 'active' : ''}`;
        // 添加指令数量
        categoryBtn.textContent = `${category} (${subCategoryCounts[category] || 0})`;
        categoryBtn.addEventListener('click', () => {
            currentSubCategory = category;
            currentPage = 1;
            loadedItemsCount = 0; // 修复：在移动端也需要重置已加载项目计数
            renderSubCategories();
            renderPromptCards(true); // 修复：在移动端需要重置卡片渲染
        });
        fragment.appendChild(categoryBtn);
    });
    
    // 一次性更新DOM
    subCategories.innerHTML = '';
    subCategories.appendChild(fragment);
}

// 渲染提示词卡片（分页/滚动加载）
function renderPromptCards(reset = false) {
    let filteredItems = [];
    
    // 根据当前分类筛选
    if (currentMainCategory && currentSubCategory) {
        filteredItems = categorizedData[currentMainCategory]?.[currentSubCategory] || [];
    } else if (currentMainCategory) {
        // 只筛选大分类
        if (categorizedData[currentMainCategory]) {
            Object.values(categorizedData[currentMainCategory] || {}).forEach(items => {
                filteredItems = filteredItems.concat(items);
            });
        }
    } else if (currentSubCategory) {
        // 只筛选小分类
        Object.values(categorizedData).forEach(subCats => {
            if (subCats[currentSubCategory]) {
                filteredItems = filteredItems.concat(subCats[currentSubCategory]);
            }
        });
    } else {
        // 没有选择分类，显示全部已加载的数据
        Object.values(categorizedData).forEach(mainCat => {
            Object.values(mainCat).forEach(items => {
                filteredItems = filteredItems.concat(items);
            });
        });
    }
    
    // 应用搜索筛选（使用缓存）
    if (searchQuery) {
        const cacheKey = searchQuery.toLowerCase();
        if (searchCache.has(cacheKey)) {
            filteredItems = searchCache.get(cacheKey);
        } else {
            filteredItems = filteredItems.filter(item => isMatch(item, searchQuery));
            searchCache.set(cacheKey, filteredItems);
        }
    }
    
    // 显示无结果提示或渲染卡片
    if (filteredItems.length === 0) {
        noResults.classList.remove('hidden');
        // 清除现有内容
        promptCardsContainer.innerHTML = '';
        // 移除加载更多按钮
        removeLoadMoreButton();
    } else {
        noResults.classList.add('hidden');
        
        // 检查是否为移动端
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // 移动端使用滚动加载模式
            if (reset) {
                // 重置已加载项目计数
                loadedItemsCount = 0;
                // 清除现有内容
                promptCardsContainer.innerHTML = '';
            }
            
            // 计算要加载的项目
            const startIndex = loadedItemsCount;
            const endIndex = Math.min(startIndex + ITEMS_PER_LOAD, filteredItems.length);
            const itemsToLoad = filteredItems.slice(startIndex, endIndex);
            
            // 添加新项目
            itemsToLoad.forEach(item => {
                const card = document.createElement('div');
                card.className = 'prompt-card fade-in';
                card.innerHTML = `
                    <h3 class="mb-1">${item.title}</h3>
                    <div class="text-xs text-gray-500 mt-auto">
                        <span>${item.subCategory}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => openPromptModal(item));
                promptCardsContainer.appendChild(card);
            });
            
            // 更新已加载项目计数
            loadedItemsCount = endIndex;
            
            // 移除现有的加载更多按钮
            removeLoadMoreButton();
            
            // 如果还有更多项目，添加"加载更多"按钮
            if (loadedItemsCount < filteredItems.length) {
                addLoadMoreButton();
            }
        } else {
            // 桌面端使用分页模式
            // 清除现有内容
            promptCardsContainer.innerHTML = '';
            
            // 实现分页
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredItems.length);
            const pageItems = filteredItems.slice(startIndex, endIndex);
            
            pageItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'prompt-card fade-in';
                card.innerHTML = `
                    <h3 class="mb-1">${item.title}</h3>
                    <div class="text-xs text-gray-500 mt-auto">
                        <span>${item.subCategory}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => openPromptModal(item));
                promptCardsContainer.appendChild(card);
            });
            
            // 添加分页控件
            renderPagination(filteredItems.length);
        }
    }
}

// 添加"加载更多"按钮
function addLoadMoreButton() {
    // 创建加载更多按钮容器
    const loadMoreContainer = document.createElement('div');
    loadMoreContainer.className = 'col-span-full text-center mt-6';
    loadMoreContainer.id = 'load-more-container';
    
    // 创建加载更多按钮
    const loadMoreButton = document.createElement('button');
    loadMoreButton.className = 'bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition-colors';
    loadMoreButton.textContent = '加载更多';
    
    // 添加加载状态指示器（默认隐藏）
    const loadingSpinner = document.createElement('div');
    loadingSpinner.className = 'hidden mt-2 text-gray-500';
    loadingSpinner.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>加载中...';
    loadingSpinner.id = 'load-more-indicator';
    
    // 点击事件处理
    loadMoreButton.addEventListener('click', () => {
        if (!isLoading) {
            loadMoreItems();
        }
    });
    
    loadMoreContainer.appendChild(loadMoreButton);
    loadMoreContainer.appendChild(loadingSpinner);
    promptCardsContainer.appendChild(loadMoreContainer);
}

// 移除"加载更多"按钮
function removeLoadMoreButton() {
    const loadMoreContainer = document.getElementById('load-more-container');
    if (loadMoreContainer) {
        loadMoreContainer.remove();
    }
}

// 加载更多项目
function loadMoreItems() {
    // 设置加载状态
    isLoading = true;
    
    // 显示加载指示器
    const loadMoreContainer = document.getElementById('load-more-container');
    if (loadMoreContainer) {
        const button = loadMoreContainer.querySelector('button');
        const indicator = document.getElementById('load-more-indicator');
        
        if (button && indicator) {
            button.classList.add('hidden');
            indicator.classList.remove('hidden');
        }
    }
    
    // 模拟网络延迟（实际应用中可能不需要）
    setTimeout(() => {
        // 重新渲染卡片（不重置）
        renderPromptCards(false);
        
        // 重置加载状态
        isLoading = false;
        
        // 隐藏加载指示器
        const loadMoreContainer = document.getElementById('load-more-container');
        if (loadMoreContainer) {
            const button = loadMoreContainer.querySelector('button');
            const indicator = document.getElementById('load-more-indicator');
            
            if (button && indicator) {
                button.classList.remove('hidden');
                indicator.classList.add('hidden');
            }
        }
    }, 300);
}

// 渲染分页控件
function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // 如果只有一页，不显示分页控件
    if (totalPages <= 1) return;
    
    const paginationContainer = document.createElement('div');
    paginationContainer.className = 'col-span-full';
    paginationContainer.id = 'pagination-controls';
    
    // 上一页按钮
    const prevButton = document.createElement('button');
    prevButton.className = `prev-btn ${currentPage === 1 ? 'disabled' : ''}`;
    prevButton.textContent = '上一页';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderPromptCards();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    paginationContainer.appendChild(prevButton);
    
    // 页码按钮 (最多显示7个页码)
    let startPage = Math.max(1, currentPage - 3);
    let endPage = Math.min(totalPages, startPage + 6);
    
    if (endPage - startPage < 6) {
        startPage = Math.max(1, endPage - 6);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => {
            currentPage = i;
            renderPromptCards();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        paginationContainer.appendChild(pageButton);
    }
    
    // 下一页按钮
    const nextButton = document.createElement('button');
    nextButton.className = `next-btn ${currentPage === totalPages ? 'disabled' : ''}`;
    nextButton.textContent = '下一页';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderPromptCards();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    paginationContainer.appendChild(nextButton);
    
    promptCardsContainer.appendChild(paginationContainer);
}

// 检查项目是否匹配搜索词
function isMatch(item, query) {
    const lowerQuery = query.toLowerCase();
    return (
        item.title.toLowerCase().includes(lowerQuery) ||
        item.chinese.toLowerCase().includes(lowerQuery) ||
        item.english.toLowerCase().includes(lowerQuery)
    );
}

// 打开提示词详情弹窗
function openPromptModal(item) {
    modalTitle.textContent = item.title;
    modalChinese.textContent = item.chinese;
    modalEnglish.textContent = item.english;
    promptModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // 防止背景滚动
}

// 关闭弹窗
function closePromptModal() {
    promptModal.classList.add('hidden');
    document.body.style.overflow = ''; // 恢复滚动
}

// 复制文本到剪贴板
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(() => {
        // 显示复制成功提示
        const toast = document.createElement('div');
        toast.className = 'copy-toast';
        toast.textContent = `${label}已复制!`;
        document.body.appendChild(toast);
        
        // 显示提示
        setTimeout(() => toast.classList.add('show'), 10);
        
        // 3秒后隐藏并移除提示
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    });
}

// 切换夜间模式
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    
    // 更新按钮图标
    const icon = themeToggle.querySelector('i');
    if (isDarkMode) {
        icon.className = 'fa fa-sun-o';
        // 保存用户偏好到本地存储
        localStorage.setItem('theme', 'dark');
    } else {
        icon.className = 'fa fa-moon-o';
        // 保存用户偏好到本地存储
        localStorage.setItem('theme', 'light');
    }
}

// 检查并应用保存的主题偏好
function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
        const icon = themeToggle.querySelector('i');
        icon.className = 'fa fa-sun-o';
    }
}

// 搜索功能
function handleSearch() {
    searchQuery = searchInput.value.trim();
    currentPage = 1;
    loadedItemsCount = 0; // 重置已加载项目计数
    renderSubCategories();
    renderPromptCards(true); // 重置卡片渲染
}

// 窗口大小改变事件处理
function handleResize() {
    // 重置页码和已加载项目计数
    currentPage = 1;
    loadedItemsCount = 0;
    // 重新渲染卡片
    renderPromptCards(true);
}

// 事件监听
closeModal.addEventListener('click', closePromptModal);
promptModal.addEventListener('click', (e) => {
    if (e.target === promptModal) {
        closePromptModal();
    }
});

copyChinese.addEventListener('click', () => {
    copyToClipboard(modalChinese.textContent, '中文提示词');
});

copyEnglish.addEventListener('click', () => {
    copyToClipboard(modalEnglish.textContent, '英文提示词');
});

searchInput.addEventListener('input', handleSearch);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleSearch();
    }
});

// 添加夜间模式切换事件监听器
themeToggle.addEventListener('click', toggleDarkMode);

// 添加窗口大小改变监听器
window.addEventListener('resize', handleResize);

// 预加载所有分类的数量信息（已移除，使用category-counts.js文件替代）

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    // 初始化所有大分类
    allMainCategories = new Set(Object.keys(categoryFileMap));
    console.log('All main categories initialized:', Array.from(allMainCategories));
    
    // 直接渲染分类（使用category-counts.js中的预加载数量）
    console.log('Rendering categories with preloaded counts');
    renderMainCategories();
    
    // 默认选择第一个大分类
    if (allMainCategories.size > 0) {
        currentMainCategory = Array.from(allMainCategories)[0];
        console.log('Default category selected:', currentMainCategory);
        // 加载默认分类的数据
        loadCategoryData(currentMainCategory).then(() => {
            console.log('Default category data loaded successfully');
            renderMainCategories();
            renderSubCategories();
            renderPromptCards(true); // 初始化时重置卡片渲染
        }).catch(error => {
            console.error('Failed to load default category data:', error);
            renderMainCategories();
            renderSubCategories();
            renderPromptCards(true); // 初始化时重置卡片渲染
        });
    } else {
        console.log('No categories found');
        renderMainCategories();
        renderSubCategories();
        renderPromptCards(true); // 初始化时重置卡片渲染
    }
    
    // 应用保存的主题偏好
    applySavedTheme();
});